name: Vercel Deployment Notifications

on:
  deployment_status:

jobs:
  notify-success:
    if: github.event.deployment_status.state == 'success' && github.event.deployment_status.environment == 'Production'
    runs-on: ubuntu-latest
    steps:
      - name: Fetch commit and PR info
        id: info
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          SHA="${{ github.event.deployment.sha }}"

          # Fetch PR data associated with this commit
          PR_JSON=$(gh api "repos/${{ github.repository }}/commits/${SHA}/pulls" 2>/dev/null || echo "[]")
          PR_URL=$(echo "$PR_JSON" | jq -r '.[0].html_url // empty')
          PR_AUTHOR=$(echo "$PR_JSON" | jq -r '.[0].user.login // empty')
          PR_TITLE=$(echo "$PR_JSON" | jq -r '.[0].title // empty')
          PR_NUMBER=$(echo "$PR_JSON" | jq -r '.[0].number // empty')

          # Get real author (fallback to commit author if no PR)
          if [ -n "$PR_AUTHOR" ]; then
            AUTHOR="$PR_AUTHOR"
          else
            AUTHOR=$(gh api "repos/${{ github.repository }}/commits/${SHA}" --jq '.author.login // .commit.author.name')
          fi

          # Get commits list
          if [ -n "$PR_NUMBER" ] && [ "$PR_NUMBER" != "null" ]; then
            COMMITS=$(gh api "repos/${{ github.repository }}/pulls/${PR_NUMBER}/commits" | \
              jq -r --arg title "$PR_TITLE" '[.[].commit.message | split("\n") | .[0]] | map(select(. != $title)) | map("‚Ä¢ " + .) | join("\n")' | head -10)
          else
            COMMITS="‚Ä¢ $(gh api "repos/${{ github.repository }}/commits/${SHA}" --jq '.commit.message | split("\n") | .[0]')"
          fi

          echo "pr_url=${PR_URL}" >> "$GITHUB_OUTPUT"
          echo "pr_title=${PR_TITLE}" >> "$GITHUB_OUTPUT"
          echo "author=${AUTHOR}" >> "$GITHUB_OUTPUT"
          echo "commits<<EOF" >> "$GITHUB_OUTPUT"
          echo "$COMMITS" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Send Slack success notification
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          PR_URL: ${{ steps.info.outputs.pr_url }}
          PR_TITLE: ${{ steps.info.outputs.pr_title }}
          AUTHOR: ${{ steps.info.outputs.author }}
          COMMITS: ${{ steps.info.outputs.commits }}
          DEPLOY_URL: ${{ github.event.deployment_status.target_url }}
          ENVIRONMENT: ${{ github.event.deployment_status.environment }}
        run: |
          # Environment emoji
          case "$ENVIRONMENT" in
            Production|production) ENV_EMOJI="üöÄ" ;;
            Preview|preview) ENV_EMOJI="üëÅÔ∏è" ;;
            *) ENV_EMOJI="üîß" ;;
          esac

          # Build modifications text
          if [ -n "$PR_TITLE" ]; then
            MODIFICATIONS=$(printf "*%s*\n%s" "$PR_TITLE" "$COMMITS")
          else
            MODIFICATIONS="${COMMITS}"
          fi

          # Build action buttons
          BUTTONS='[{"type":"button","text":{"type":"plain_text","text":"Voir le d√©ploiement","emoji":true},"url":"'"${DEPLOY_URL}"'","style":"primary"}'
          if [ -n "$PR_URL" ]; then
            BUTTONS="${BUTTONS}"',{"type":"button","text":{"type":"plain_text","text":"Voir la PR","emoji":true},"url":"'"${PR_URL}"'"}'
          fi
          BUTTONS="${BUTTONS}]"

          # Build payload
          PAYLOAD=$(jq -n \
            --arg env_emoji "$ENV_EMOJI" \
            --arg environment "$ENVIRONMENT" \
            --arg author "$AUTHOR" \
            --arg modifications "$MODIFICATIONS" \
            --argjson buttons "$BUTTONS" \
            '{
              "attachments": [
                {
                  "color": "#22C55E",
                  "blocks": [
                    {
                      "type": "header",
                      "text": {
                        "type": "plain_text",
                        "text": "‚úÖ D√©ploiement Vercel r√©ussi",
                        "emoji": true
                      }
                    },
                    {
                      "type": "section",
                      "fields": [
                        {
                          "type": "mrkdwn",
                          "text": ("*Environnement*\n" + $env_emoji + " " + $environment)
                        },
                        {
                          "type": "mrkdwn",
                          "text": ("*Auteur*\n" + $author)
                        }
                      ]
                    },
                    {
                      "type": "section",
                      "text": {
                        "type": "mrkdwn",
                        "text": ("*üìù Modifications*\n" + $modifications)
                      }
                    },
                    {
                      "type": "actions",
                      "elements": $buttons
                    }
                  ]
                }
              ]
            }')

          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d "$PAYLOAD"

  notify-failure:
    if: github.event.deployment_status.state == 'error' || github.event.deployment_status.state == 'failure'
    runs-on: ubuntu-latest
    steps:
      - name: Fetch commit and PR info
        id: info
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          SHA="${{ github.event.deployment.sha }}"

          # Fetch PR data associated with this commit
          PR_JSON=$(gh api "repos/${{ github.repository }}/commits/${SHA}/pulls" 2>/dev/null || echo "[]")
          PR_URL=$(echo "$PR_JSON" | jq -r '.[0].html_url // empty')
          PR_AUTHOR=$(echo "$PR_JSON" | jq -r '.[0].user.login // empty')
          PR_TITLE=$(echo "$PR_JSON" | jq -r '.[0].title // empty')
          PR_NUMBER=$(echo "$PR_JSON" | jq -r '.[0].number // empty')

          # Get real author (fallback to commit author if no PR)
          if [ -n "$PR_AUTHOR" ]; then
            AUTHOR="$PR_AUTHOR"
          else
            AUTHOR=$(gh api "repos/${{ github.repository }}/commits/${SHA}" --jq '.author.login // .commit.author.name')
          fi

          # Get commits list
          if [ -n "$PR_NUMBER" ] && [ "$PR_NUMBER" != "null" ]; then
            COMMITS=$(gh api "repos/${{ github.repository }}/pulls/${PR_NUMBER}/commits" | \
              jq -r --arg title "$PR_TITLE" '[.[].commit.message | split("\n") | .[0]] | map(select(. != $title)) | map("‚Ä¢ " + .) | join("\n")' | head -10)
          else
            COMMITS="‚Ä¢ $(gh api "repos/${{ github.repository }}/commits/${SHA}" --jq '.commit.message | split("\n") | .[0]')"
          fi

          echo "pr_url=${PR_URL}" >> "$GITHUB_OUTPUT"
          echo "pr_title=${PR_TITLE}" >> "$GITHUB_OUTPUT"
          echo "author=${AUTHOR}" >> "$GITHUB_OUTPUT"
          echo "commits<<EOF" >> "$GITHUB_OUTPUT"
          echo "$COMMITS" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Send Slack failure notification
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          PR_URL: ${{ steps.info.outputs.pr_url }}
          PR_TITLE: ${{ steps.info.outputs.pr_title }}
          AUTHOR: ${{ steps.info.outputs.author }}
          COMMITS: ${{ steps.info.outputs.commits }}
          DEPLOY_URL: ${{ github.event.deployment_status.target_url }}
          ENVIRONMENT: ${{ github.event.deployment_status.environment }}
        run: |
          # Environment emoji
          case "$ENVIRONMENT" in
            Production|production) ENV_EMOJI="üöÄ" ;;
            Preview|preview) ENV_EMOJI="üëÅÔ∏è" ;;
            *) ENV_EMOJI="üîß" ;;
          esac

          # Build modifications text
          if [ -n "$PR_TITLE" ]; then
            MODIFICATIONS=$(printf "*%s*\n%s" "$PR_TITLE" "$COMMITS")
          else
            MODIFICATIONS="${COMMITS}"
          fi

          # Build action buttons
          BUTTONS='[{"type":"button","text":{"type":"plain_text","text":"Voir les logs","emoji":true},"url":"'"${DEPLOY_URL}"'","style":"danger"}'
          if [ -n "$PR_URL" ]; then
            BUTTONS="${BUTTONS}"',{"type":"button","text":{"type":"plain_text","text":"Voir la PR","emoji":true},"url":"'"${PR_URL}"'"}'
          fi
          BUTTONS="${BUTTONS}]"

          # Build payload
          PAYLOAD=$(jq -n \
            --arg env_emoji "$ENV_EMOJI" \
            --arg environment "$ENVIRONMENT" \
            --arg author "$AUTHOR" \
            --arg modifications "$MODIFICATIONS" \
            --argjson buttons "$BUTTONS" \
            '{
              "text": "<!here> üö® Build Vercel √©chou√© !",
              "attachments": [
                {
                  "color": "#EF4444",
                  "blocks": [
                    {
                      "type": "header",
                      "text": {
                        "type": "plain_text",
                        "text": "üö® Build Vercel √©chou√© !",
                        "emoji": true
                      }
                    },
                    {
                      "type": "section",
                      "fields": [
                        {
                          "type": "mrkdwn",
                          "text": ("*Environnement*\n" + $env_emoji + " " + $environment)
                        },
                        {
                          "type": "mrkdwn",
                          "text": ("*Auteur*\n" + $author)
                        }
                      ]
                    },
                    {
                      "type": "section",
                      "text": {
                        "type": "mrkdwn",
                        "text": ("*üìù Modifications*\n" + $modifications)
                      }
                    },
                    {
                      "type": "actions",
                      "elements": $buttons
                    }
                  ]
                }
              ]
            }')

          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d "$PAYLOAD"
